// saveTranscript.js
const fs = require("fs");
const path = require("path");

// نخلي مسار واحد للـ template داخل مجلد site
const TEMPLATE_PATH = path.join(__dirname, "site", "template.html");
const TRANSCRIPTS_PATH = process.env.TRANSCRIPTS_PATH || path.join(__dirname, "site", "transcripts");
const GITHUB_PAGES_BASE = process.env.GITHUB_PAGES_BASE || "https://yourname.github.io/yourrepo/transcripts";

// نتأكد أن مجلد transcripts راهو موجود
if (!fs.existsSync(TRANSCRIPTS_PATH)) {
  fs.mkdirSync(TRANSCRIPTS_PATH, { recursive: true });
}

function escapeHtml(s) {
  if (!s) return "";
  return s.replace(/&/g,"&amp;")
           .replace(/</g,"&lt;")
           .replace(/>/g,"&gt;");
}

function buildTranscriptHTML(messages, channel, openerUser) {
  const header = fs.readFileSync(TEMPLATE_PATH, "utf8");

  const rows = messages.map(m => {
    const time = new Date(m.createdTimestamp).toLocaleString();
    const author = escapeHtml(m.author?.tag || m.author?.username || "Unknown");
    const avatar = m.author?.displayAvatarURL?.() || "https://cdn.discordapp.com/embed/avatars/0.png";
    const content = escapeHtml(m.cleanContent || m.content || "").replace(/\n/g, "<br>");
    const attachments = m.attachments && m.attachments.size
      ? Array.from(m.attachments.values())
          .map(a => `<div class="att"><a href="${a.url}" target="_blank">${escapeHtml(a.name || a.url)}</a></div>`)
          .join("")
      : "";

    return `
    <div class="message">
      <img class="avatar" src="${avatar}" alt="avatar">
      <div class="message-body">
        <div class="meta"><span class="author">${author}</span> <span class="time">${time}</span></div>
        <div class="content">${content}</div>
        ${attachments}
      </div>
    </div>`;
  }).join("\n");

  return header
    .replace("{{CHANNEL_NAME}}", escapeHtml(channel.name))
    .replace("{{GUILD_NAME}}", escapeHtml(channel.guild?.name || ""))
    .replace("{{MESSAGES}}", rows)
    .replace("{{GENERATED_AT}}", new Date().toLocaleString())
    .replace("{{OPENER}}", escapeHtml(openerUser?.tag || "Unknown"));
}

async function saveTranscript(channel, openerUser, limit = 1000) {
  let all = [];
  let lastId = null;

  while (true) {
    const options = { limit: 100 };
    if (lastId) options.before = lastId;

    const fetched = await channel.messages.fetch(options);
    if (!fetched || fetched.size === 0) break;

    all.push(...Array.from(fetched.values()));
    lastId = fetched.last().id;
    if (all.length >= limit) break;
  }

  all = all.sort((a, b) => a.createdTimestamp - b.createdTimestamp);

  const html = buildTranscriptHTML(all, channel, openerUser);
  const fileName = `${channel.id}.html`;
  const filePath = path.join(TRANSCRIPTS_PATH, fileName);

  fs.writeFileSync(filePath, html, "utf8");
  const publicUrl = `${GITHUB_PAGES_BASE}/${fileName}`;

  return { filePath, publicUrl };
}

module.exports = { saveTranscript };
